<!DOCTYPE html>
<html>
	<head>
		<!-- USE DEVELOPMENT VERSION -->
		<script src="https://unpkg.com/konva@3.2.4/konva.min.js"></script>
		<meta charset="utf-8" />
		<title>Konva Keep Ratio Demo</title>
		<style>
			body {
				margin: 0;
				padding: 0;
				/* overflow: hidden; */
				background-color: #f0f0f0;
			}
			#containerWrapper {
				width: 60vw;
				height: 60vh;
				margin: 0 auto;
				border: 3px solid blue;
			}
			#container {
				border: 1px solid red;
			}
		</style>
	</head>

	<body>
		<label>
			Text:
			<input id="title" value="КЛИКБЕЙТНЫЙ ЗАГОЛОВОК">
		</label>
		<label>
			Text Color:
			<input id="textColor" value="#000000" type="color">
		</label>
		<label>
			Background Color:
			<input id="bgColor" value="#ffffff" type="color">
		</label>


		<button id="btnUpdate">Обновить</button>
		<button id="btnToQuery">В очередь</button>

		<div id="containerWrapper">
			<div id="container"></div>
		</div>
		<script>

			window.onload = function() { bootstrapDocument(); }

			function bootstrapDocument(){
				console.log('document loaded');
				//console.log(window.konvastage.find('#ObjectVaiderImage'));
				// console.log(window.konvastage);
				
				
				var bgColorObject = document.getElementById('bgColor');
				bgColorObject.oninput = function() {
					document.getElementById('container').style.backgroundColor = bgColorObject.value;
				};

				var textColor = document.getElementById('textColor');
				textColor.oninput = function() {
					window.konvastage.find('#textObject')[0].fill(textColor.value);
					window.konvastage.find('#layerObject')[0].draw();
				};
			}

			function fixSizes(w,h,dw,dh,comment=false) {
				// console.log([w,h],[dw,dh]);
				if (w>dw) {
					// console.log("w>dw");
					if (w>h) {
						// console.log("w>h");
						let aspect = dw/w;
						h = Math.round(h*aspect);
						w = dw;
					}
					if (h>w) {
						// console.log("h>w");
						let aspect = dw/w;
						h = Math.round(h*aspect);
						w = dw;
					}
					if (h==w) {
						// console.log("h==w");
						let aspect = dw/w;
						h = Math.round(h*aspect);
						w = dw;
					}
				}
				// console.log(["after w>dw",w,h,comment]);


				if (h>dh) {
					// console.log("h>dh");
					let aspect = dh/h;
					w = Math.round(w*aspect);
					h = dh;
				}
				// console.log(["after h>dh",w,h,comment]);


				return [w,h];
			}

			function dragBoundFuncHelper(pos,cobj) {
				var newY = pos.y;
				var newX = pos.x;
				var actualWidth = cobj.attrs.width*cobj.attrs.scaleY;
				var actualHeight = cobj.attrs.height*cobj.attrs.scaleX;
				var canvasHeight = cobj.parent.canvas.height;
				var canvasWidth = cobj.parent.canvas.width;

				if (pos.y < 0) { newY = 0; }
				if (pos.y > canvasHeight-actualHeight) { newY = canvasHeight-actualHeight; }


				if (pos.x < 0) { newX = 0; }
				if (pos.x > canvasWidth-actualWidth) { newX = canvasWidth-actualWidth; }

				return {
					x: newX,
					y: newY
				};
			}

			function boundBoxFuncHelper(oldBoundBox, newBoundBox, cobj){
				var canvasHeight = cobj.parent.canvas.height;
				var canvasWidth = cobj.parent.canvas.width;

				if (newBoundBox.width+newBoundBox.x > canvasWidth) {
					newBoundBox.width = canvasWidth-newBoundBox.x;
					newBoundBox.height = newBoundBox.width*(oldBoundBox.height/oldBoundBox.width);
				}
				if (newBoundBox.x < 0) {
					newBoundBox.x = 0;
					newBoundBox.width = oldBoundBox.width;
					newBoundBox.height = newBoundBox.width*(oldBoundBox.height/oldBoundBox.width);
				}
				if (newBoundBox.y < 0) {
					newBoundBox.y = 0;
					newBoundBox.height = oldBoundBox.height;
					newBoundBox.width = newBoundBox.height*(oldBoundBox.width/oldBoundBox.height);
				}

				return newBoundBox;
			}

			function drawCanvas(optSize, optText, optPath, optType){
				
				var wrapper = [document.getElementById('containerWrapper').clientWidth, document.getElementById('containerWrapper').clientHeight];
				// console.log(["containerWraper size: ", wrapper[0], wrapper[1]]);
				// aspect ratio is 1080,1920 for IGTV
				
				var canvasSizes = fixSizes(1080,1920,wrapper[0],wrapper[1],"canvas");

				document.getElementById('container').style.width = canvasSizes[0]+'px';
				document.getElementById('container').style.height = canvasSizes[1]+'px';
				document.getElementById('container').style.margin = "0 auto";
				document.getElementById('container').style.backgroundColor = "white";

				window.konvastage = new Konva.Stage({
					container: 'container',
					width: canvasSizes[0],
					height: canvasSizes[1],
				});


				var layer = new Konva.Layer({
					id: 'layerObject'
				});
				window.konvastage.add(layer);

				/**
				 * OBJECT 1 START
				 * */
				var imageDOMObject = new Image();
				imageDOMObject.src = optPath;
				imageDOMObject.onload = function() {
					imageObject.image(imageDOMObject);
					layer.draw();
				};
				
				optSize = fixSizes(optSize[0],optSize[1],canvasSizes[0],canvasSizes[1],"optSize - 1th object");

				var imageObject = new Konva.Image({
					width: optSize[0],
					height: optSize[1],
					draggable: true,
					id: "imageObject",
					dragBoundFunc: function(pos) { return dragBoundFuncHelper(pos, this); }
				});
		
				layer.add(imageObject);

				var imageTransformer = new Konva.Transformer({
					node: imageObject,
					id: "imageTransformer",
					keepRatio: true,
					width: optSize[0],
					height: optSize[1],
					enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
					boundBoxFunc: function(oldBoundBox, newBoundBox) { return boundBoxFuncHelper(oldBoundBox, newBoundBox, this); }
				});
				layer.add(imageTransformer);
				/**
				 * OBJECT 1 END
				 * */


				/**
				 * TEXT 2 START
				 * */
				var textObject = new Konva.Text({
					x: 0,
					y: 0,
					fontSize: 30,
					text: optText,
					draggable: true,
					id: 'textObject',
					fillEnabled: true,
					dragBoundFunc: function(pos) { return dragBoundFuncHelper(pos, this); }
				});
				layer.add(textObject);

				

				var textTransformer = new Konva.Transformer({
					node: textObject,
					id: 'textTransformer',
					keepRatio: true,
					enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
					boundBoxFunc: function(oldBoundBox, newBoundBox) { return boundBoxFuncHelper(oldBoundBox, newBoundBox, this); }
				});
				layer.add(textTransformer);
				/**
				* TEXT 2 END
				* */

				layer.draw();
			}


			/* fake ajax request and responce */
			function getFileInfo(){
				return {size: [2048,1403], text: 'КЛИКБЕЙТНЫЙ ЗАГОЛОВОК', path: './assets/darth-vader.jpg', type: 'image'};
			}


			var fileObject = getFileInfo();
			drawCanvas(fileObject.size, fileObject.text, fileObject.path);



		</script>
	</body>
</html>
